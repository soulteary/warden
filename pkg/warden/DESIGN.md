# Warden SDK 设计说明

## 设计原则

1. **简单易用**：提供简洁的 API 接口
2. **高性能**：内置缓存支持，减少 API 调用
3. **线程安全**：所有方法都是并发安全的
4. **灵活配置**：支持自定义超时、缓存、日志等

## 架构设计

### 核心组件

1. **Client**：HTTP 客户端封装
2. **Cache**：线程安全的内存缓存
3. **Options**：配置选项（使用 Builder 模式）
4. **Logger**：日志接口（支持不同日志库）

### 并发安全

- `http.Client` 是并发安全的
- `Cache` 使用 `sync.RWMutex` 保证线程安全
- `Client` 的所有字段在创建后都是只读的
- 所有方法都是线程安全的，可以在多个 goroutine 中并发调用

### 缓存策略

1. **GetUsers()**：使用缓存
   - 首先检查缓存
   - 如果缓存有效，直接返回
   - 如果缓存无效或不存在，从 API 获取并更新缓存

2. **GetUsersPaginated()**：不使用缓存
   - 原因：不同的分页参数会产生不同的结果
   - 如果实现分页缓存，需要按分页参数缓存，复杂度较高
   - 当前设计：每次都从 API 获取，保证数据准确性

3. **CheckUserInList()**：间接使用缓存
   - 通过调用 `GetUsers()` 间接使用缓存
   - 如果缓存有效，不会发起新的 API 请求

### 错误处理

- 使用自定义 `Error` 类型，包含错误代码和详细信息
- 支持错误包装（`Unwrap()` 方法）
- 所有错误都实现了 `error` 接口

### 配置验证

- `Validate()` 方法会规范化 `BaseURL`（添加协议、去除尾部斜杠）
- 验证超时时间和缓存 TTL
- 如果未提供 Logger，使用 `NoOpLogger`

## 已知限制

1. **HTTP Transport 配置**：当前不支持自定义 `http.Transport`
   - 对于大多数场景，默认配置已足够
   - 如需自定义 TLS、代理等，可以在后续版本中添加

2. **分页缓存**：`GetUsersPaginated()` 不使用缓存
   - 这是有意的设计，保证数据准确性
   - 如需分页缓存，可以实现更复杂的缓存策略

3. **缓存失效**：当前只支持 TTL 过期
   - 不支持手动设置过期时间
   - 不支持基于事件的缓存失效

## 使用建议

1. **复用 Client**：创建一次 Client，在整个应用生命周期中复用
2. **合理设置缓存 TTL**：根据数据更新频率设置合适的缓存时间
3. **使用 Context**：传递 context 以支持取消和超时控制
4. **错误处理**：始终检查并处理错误
5. **日志记录**：在生产环境中使用合适的日志实现

## 未来改进方向

1. 支持自定义 `http.Transport`
2. 支持基于事件的缓存失效
3. 支持重试机制
4. 支持请求/响应中间件
5. 支持指标收集（metrics）